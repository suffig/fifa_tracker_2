<!DOCTYPE html>
<html>
<head>
    <title>Test Visibility Change Handler</title>
</head>
<body>
    <div id="status">Status: Loading...</div>
    <div id="log"></div>
    
    <script>
        // Mock the supabase functionality to test the visibility logic
        let isInitializing = false;
        let isAppVisible = true;
        let visibilityChangeCount = 0;
        
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        
        function logMessage(msg) {
            console.log(msg);
            const p = document.createElement('p');
            p.textContent = new Date().toLocaleTimeString() + ': ' + msg;
            log.appendChild(p);
        }
        
        function handleVisibilityChange() {
            const wasVisible = isAppVisible;
            isAppVisible = !document.hidden;
            visibilityChangeCount++;
            
            logMessage(`Visibility changed #${visibilityChangeCount}: wasVisible=${wasVisible}, isAppVisible=${isAppVisible}`);
            
            if (!isAppVisible && wasVisible) {
                logMessage('Tab became hidden - would cleanup subscriptions');
                status.textContent = 'Status: Hidden - subscriptions cleaned up';
            } else if (isAppVisible && !wasVisible) {
                logMessage('Tab became visible - would reinitialize');
                status.textContent = 'Status: Visible - reinitializing...';
                
                // Test the initialization logic
                setTimeout(async () => {
                    try {
                        if (isInitializing) {
                            logMessage('Already initializing, skipping...');
                            return;
                        }
                        
                        isInitializing = true;
                        logMessage('Starting reinitialization...');
                        
                        // Simulate session check
                        await new Promise(resolve => setTimeout(resolve, 100));
                        logMessage('Session validated');
                        
                        // Simulate data reset and reload
                        logMessage('Resetting data states...');
                        logMessage('Setting up subscriptions...');
                        logMessage('Rendering current tab...');
                        
                        status.textContent = 'Status: Reinitialized successfully';
                        logMessage('Reinitialization complete!');
                    } catch (error) {
                        logMessage('Error during reinitialization: ' + error.message);
                        status.textContent = 'Status: Error during reinitialization';
                    } finally {
                        isInitializing = false;
                    }
                }, 100);
            }
        }
        
        // Register the visibility change handler
        document.addEventListener('visibilitychange', handleVisibilityChange);
        logMessage('Visibility change handler registered');
        status.textContent = 'Status: Ready - switch tabs to test';
        
        // Test manual trigger
        setTimeout(() => {
            logMessage('=== SIMULATING TAB SWITCH ===');
            Object.defineProperty(document, 'hidden', { value: true, configurable: true });
            handleVisibilityChange();
            
            setTimeout(() => {
                Object.defineProperty(document, 'hidden', { value: false, configurable: true });
                handleVisibilityChange();
            }, 1000);
        }, 2000);
    </script>
</body>
</html>